---
title: "Developer and Financier Survey"
author: "Jacob Ford, Solstice Data Scientist"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    toc_depth: 5

knit: (function(inputFile, encoding) { 
        rmarkdown::render(inputFile, encoding = encoding, 
        output_file = file.path(dirname(inputFile), 'developer_and_financier.html')) })
---


```{r message=FALSE, warning=FALSE, include=FALSE}

#Load packages we'll need throughout the entire document
library(readxl)
library(sf)
library(dplyr)
library(janitor)
library(dplyr)
library(tidycensus)
library(tidyverse)
options(tigris_use_cache = TRUE)
library(nngeo)
library(plotly)
library(kableExtra)
library(haven)
library(rms)
library(rmdformats)
library(ggplot2)
library(plotly)
library(gtsummary)


options(scipen = 100)


```

```{r message=FALSE, warning=FALSE, include=FALSE}

## Change the below to match your local drive ##

input_folder <- '/Volumes/GoogleDrive-111165283491444964488/Shared drives/Solstice | Low Income Inclusion/05_Research/05.01_SETO/DOE SETO Project Implementation/Project Management/SETO Data Analysis/'

dev_input = paste(input_folder, "2. Developer and Financier/", sep="")


setwd(input_folder)


```




# Introduction

Entities providing financial capital needed to site potential land plots, conduct environmental impact analyses, and fund construction are essential to community solar farms. While the Community Priorities survey reached out to potential customers, this element of the research seeks to establish qualitative measures of developer and financier preferences and perceived barriers to better serving LMI population.  

# Methods

Due to the exploratory nature of this research, we intends to leave analyses associated with the developer and financier component of this research unstructured in part. As a result of the expected small sample size, described in more detail below, we do not expect to be able to test for significance between observations. Rather, this analysis will be conducted through a detailed analysis of primary data collected via survey responses. Absence of existing published data detailing limiting factors and decision points related to constructing community solar  subscriber agreements makes it difficult to establish a baseline in order to conduct hypotheses-generated analyses as outlined in previous sections. This research takes a grounded theory approach to construct theory through primary data collection and subsequent comparative analysis. 



The primary outcome of this research will be collecting and analyzing average terms used by solar developers and financiers in existing community solar contracts. The secondary outcome of the survey responses from developers and financiers will be measured by variables suggested to influence and limit offerings for existing community solar products.


The developer and financier research consists of an analysis of survey data in which each respondent was asked to provide estimated community solar contract attributes, including estimated savings rate, term length and cancellation fee. Respondents were asked if these rates differ when being offered to LMI respondents, and if the difference was positive or negative relative to the general population. Finally, information was collected regarding feedback on potential loan loss reserve characteristics, including ideal length of time and total project revenue to be covered. 

Additionally, community solar access for LMI population is qualitatively coded using a Likert scale, by which respondents recorded the relative degree of importance. These factorized survey questions included three main sections. The first related to a variety of factors that may influence the respondents ability to make community solar projects accessible to LMI populations. Secondly, which internal factors were most important that lead to the inclusion of LMI populations. Finally, what factors effect the project's ability to fill out enrollment in a timely and efficient manner. 



## Data Collection



There were 254 unique responses. 

```{r message=FALSE, warning=FALSE, include=FALSE}

devd_raw <- read.csv(paste(dev_input, "input/Developer and Financier Survey_July 20, 2022_06.45.csv", sep=""))



#remove first two rows of data + only include finished responses

devd <- devd_raw[-1:-2,] %>%
  filter(Finished=="True") %>%
  mutate(Latitude = round(as.double(LocationLatitude),2),
         Longitude = round(as.double(LocationLongitude),2))

devd <- st_as_sf(devd,coords = c("Longitude", "Latitude"))

# Labels for Factor variables 
savings_levels <- c("0-5% savings per month", "6-10% savings per month", "11-15% savings per month",
  "16-20% savings per month", "21-50% savings per month")

term_levels <- c("No minimum length", "1-3 years", "4-6 years",
  "7-10 years", "11-15 years", "16-20 years", "20 or more years")

cancel_levels <- c("No cancellation fee", "$1-$100", "$101-$250", "$251-$500",
                   "$501-$1,000", "More than $1,000")

differ_levels <- c("Yes", "No", "Unsure")

# factor(sizes, levels = c("small", "medium", "large"))
# 
# 
# devd$savings_rate <- factor(devd$Q11,

dev_sum <- devd %>%
  st_drop_geometry() %>%
  mutate(
      #Savings Rates
      savings_rate = Q11,
      savings_rate_differ = Q12,
      savings_rate_lmi_differ = case_when(
        Q13 == "Higher savings" ~ Q13,
        Q13 == "Lower savings" ~ Q13),
      
      #Term Length
      term_length = Q14,
      term_length_differ = Q15,
      term_length_lmi_differ = case_when(
        Q16 == "Longer terms" ~ Q16,
        Q16 == "Shorter terms" ~ Q16),
      
      #Cancellation Fee
      cancel_fee = Q17,
      cancel_fee_differ = Q18,
      cancel_fee_lmi_differ = case_when(
        Q19 == "Higher cancellation fees" ~ Q19,
        Q19 == "Lower cancellation fees" ~ Q19),  
      
      #Perceived default rate for market
      default_market = Q27_1,
      default_lmi = Q27_2,
      
      #Perceived churn rate for market
      churn_market = Q27_1.1,
      churn_lmi = Q27_2.1,
      
    ) %>%
  
  # Drop NA values and other erroneous entries
  filter(savings_rate %in% savings_levels) %>%
  filter(term_length %in% term_levels) %>%
  filter(cancel_fee %in% cancel_levels) %>%
  
  #Apply factor levels
  mutate(savings_rate = factor(savings_rate, levels=savings_levels),
         savings_rate_differ = factor(savings_rate_differ, levels=differ_levels),
         
         term_length = factor(term_length, levels=term_levels),
         term_length_differ = factor(term_length_differ, levels=differ_levels),
         
         cancel_fee = factor(cancel_fee, levels=cancel_levels),
         cancel_fee_differ = factor(cancel_fee_differ, levels=differ_levels))

```

# Results

## Descriptive Statistics

<style>
### Savings Rate
{
   display: none;
 }
</style>




```{r echo=FALSE, message=FALSE, warning=FALSE}
temp <- dev_sum %>% 
  select(`Savings Rate`= savings_rate,
         `Savings Rate Differ for LMI` = savings_rate_differ,
         `If Differ, higher or lower` = savings_rate_lmi_differ
         
        #  `Term Length` = term_length,
        #  `Term Length Differ for LMI` = term_length_differ,
        #  
        #  `Cancellation Fee` = cancel_fee,
        #  `Cancellation Fee Differ for LMI` = cancel_fee_differ,
        #  
        # `Estimated default rate for Market`= default_market,
        #  `Estimated default rate for LMI` = default_lmi,
        #  
        #  
        #  `Highest Churn Rate by Project Phase` = Q30_1,
        #  `Highest Default Rate by Project Phase` = Q30_2
         ) 

# summarize the data with our package
table1 <- tbl_summary(
  temp,
  by=`Savings Rate Differ for LMI`,
  missing='ifany',
  ) %>% # test for a difference between groups
  modify_header(label = "**Table 1: Average Savings Rate by Rates Differing for LMI Customers**") %>% # update the column header
  bold_labels()

table1
```

Average market wide savings rate are shown in Table 1. 

*to-do* add takeaways for Table 1

<style>
### Term Length
{
   display: none;
 }
</style>

```{r echo=FALSE, message=FALSE, warning=FALSE}
temp <- dev_sum %>% 
  select(

         `Term Length` = term_length,
         `Differ for LMI` = term_length_differ,
         `If Differ, higher or lower` = term_length_lmi_differ


        #  `Cancellation Fee` = cancel_fee,
        #  `Cancellation Fee Differ for LMI` = cancel_fee_differ,
        # 
        # `Estimated default rate for Market`= default_market,
        #  `Estimated default rate for LMI` = default_lmi,
        # 
        # 
        #  `Highest Churn Rate by Project Phase` = Q30_1,
        #  `Highest Default Rate by Project Phase` = Q30_2
         ) 

# summarize the data with our package
table2 <- tbl_summary(
  temp,
  by=`Differ for LMI`,
  missing='ifany',
  ) %>% # test for a difference between groups
  modify_header(label = "**Table 2: Average Term Rate by Term Differing for LMI Customers**") %>% # update the column header
  bold_labels()

table2
```

Average market term lengths  are shown in Table 2. For those respondents who marked that term rates differ for LMI customers, the majority (58%) noted the term lengths are longer relative to the general population. 

*to-do* add takeaways for Table 2



<style>
### Cancellation Fee
{
   display: none;
 }
</style>



```{r echo=FALSE, message=FALSE, warning=FALSE}
temp <- dev_sum %>% 
  select(

         # `Cancellation Length` = term_length,
         # `Differ for LMI` = term_length_differ,
         # `If Differ, higher or lower` = term_length_lmi_differ


         `Cancellation Fee` = cancel_fee,
         `Differ for LMI` = cancel_fee_differ,
        `If Differ, higher or lower` = cancel_fee_lmi_differ

        # 
        # `Estimated default rate for Market`= default_market,
        #  `Estimated default rate for LMI` = default_lmi,
        # 
        # 
        #  `Highest Churn Rate by Project Phase` = Q30_1,
        #  `Highest Default Rate by Project Phase` = Q30_2
         ) 

# summarize the data with our package
table3 <- tbl_summary(
  temp,
  by=`Differ for LMI`,
  missing='ifany',
  ) %>% # test for a difference between groups
  modify_header(label = "**Table 3: Average Cancellation Fee by Term Differing for LMI Customers**") %>% # update the column header
  bold_labels()

table3
```


Average cancellation fees are shown in Table 3. Respondents were recorded that cancellation rates were lower for LMI populations relative to the market average. As shown in Table 3, 77% of developers and financiers who responded that cancellation fees differed for LMI customers offer lower cancellation fees. 

*to-do* add takeaways for Table 3


<style>
### Churn and Default
{
   display: none;
 }
</style>



```{r echo=FALSE, message=FALSE, warning=FALSE}
temp <- dev_sum %>% 
  select(
        #  
        `Estimated default rate for Market`= default_market,
         `Estimated default rate for LMI` = default_lmi,


         `Highest Churn Rate by Project Phase` = Q30_1,
         `Highest Default Rate by Project Phase` = Q30_2
         ) 

# summarize the data with our package
table4 <- tbl_summary(
  temp,
  #by=`Savings Rate Differ for LMI`,
  missing='ifany',
  ) %>% 
  modify_header(label = "**Table 4: Average Churn and Default Rates**") %>% 
  bold_labels()

table4
```

When asked to estimate the default rates for community solar customers, the difference for general market and LMI population is stark. When asked to estimate default rates for the general market, nearly 90% of respondents estimated that default rates would be below 8%. For LMI customers, the proportional total fell to 83% of respondents. 

*to-do* add takeaways for Table 4



<style>
### Loan Loss Reserve
{
   display: none;
 }
</style>



```{r echo=FALSE, message=FALSE, warning=FALSE}

risk_levels <- c("Moderately unlikely","Slightly unlikely" , "Neither likely nor unlikely", "Moderately likely", "Slightly likely", "Extremely likely")

temp <- dev_sum %>% 
  select(
        #  
        `Importance of Loan Loss Reserve`= Q33_1,
        `Ideal Percentage of Loan Loss Reserve`= Q34_1,
        
        `Ideal Coverage Time` = Q35_1,

         ) 

temp$`Ideal Percentage of Loan Loss Reserve` <- as.integer(temp$`Ideal Percentage of Loan Loss Reserve`)

#Removed values of ideal loss reserve revenue protection of 2018 anad 50000

temp <- temp %>%
  mutate(
    `Ideal Coverage Time` = as.integer(`Ideal Coverage Time`),
  ) %>%
  filter(!is.na(`Ideal Coverage Time`)) %>%
  filter(`Ideal Coverage Time` < 2000)

# summarize the data with our package
table5 <- tbl_summary(
  temp,
  #by=`Savings Rate Differ for LMI`,
  missing='no',
  statistic = list(all_continuous() ~ "{mean} ({sd})"),
  ) %>% 
  modify_header(label = "**Table 5: Loan Loss Reserve**") %>% 
  bold_labels()

table5
```



<style>
### Ability to make CS Accessible to LMI
{
   display: none;
 }
</style>




```{r message=FALSE, warning=FALSE, include=FALSE}

importance_levels <- c("Not at all important", "Slightly important", "Moderately important", "Very important", "Extremely important")


table2_data <- dev_sum %>% 
  select(`Customer Acquisition Costs`= Q21_1,
         `Churn`= Q21_2,
         `Default`= Q21_3,
         `Communication`= Q21_4,
         `LMI Identification`= Q21_5,
         `Financing`= Q21_6) 

table2_data$`Customer Acquisition Costs` <- factor(table2_data$`Customer Acquisition Costs`, levels=importance_levels)
table2_data$`Churn` <- factor(table2_data$`Churn`, levels=importance_levels)
table2_data$`Default` <- factor(table2_data$`Default`, levels=importance_levels)
table2_data$`Communication` <- factor(table2_data$`Communication`, levels=importance_levels)
table2_data$`LMI Identification` <- factor(table2_data$`LMI Identification`, levels=importance_levels)
table2_data$`Financing` <- factor(table2_data$`Financing`, levels=importance_levels)
  


# summarize the data with our package
table2 <- tbl_summary(
  table2_data,
 # by=y_signup,
  missing='no',
  ) %>% # test for a difference between groups
  modify_header(label = "**Table 2: Developer and Financier Priorities: Ability to make CS accessibility to LMI**") %>% # update the column header
  bold_labels()

table2
```


<style>
### Factors Influence Decision to include LMI
{
   display: none;
 }
</style>



```{r message=FALSE, warning=FALSE, include=FALSE}



table3_data <- dev_sum %>% 
  select(`Policy`= Q24_1,
         `Community Interest`= Q24_2,
         `Financier Interest`= Q24_3,
         `Company Interest`= Q24_4,
         `Equity`= Q24_5)

table3_data$`Policy` <- factor(table3_data$`Policy`, levels=importance_levels)
table3_data$`Community Interest` <- factor(table3_data$`Community Interest`, levels=importance_levels)
table3_data$`Financier Interest` <- factor(table3_data$`Financier Interest`, levels=importance_levels)
table3_data$`Company Interest` <- factor(table3_data$`Company Interest`, levels=importance_levels)
table3_data$`Equity` <- factor(table3_data$`Equity`, levels=importance_levels)

  


# summarize the data with our package
table3 <- tbl_summary(
  table3_data,
 # by=y_signup,
  missing='no',
  ) %>% # test for a difference between groups
  modify_header(label = "**Table 3: Developer and Financier Priorities: Factors Influence Decision to include LMI**") %>% # update the column header
  bold_labels()

table3
```

<style>
### Factors to Fill out CS Projects Quickly
{
   display: none;
 }
</style>




```{r message=FALSE, warning=FALSE, include=FALSE}
importance_levels <- c("Definitely not", "Probably not", "Might or might not", "Probably yes", "Definitely yes")



table4_data <- dev_sum %>% 
  select(`Savings Rate`= Q26_1,
         `Term Length`= Q26_2,
         `Cancellation Fee`= Q26_3,
         `No On-Bill Credit`= Q26_4,
         `On-Bill Credit`= Q26_5,
         `Contract Complexity` = Q26_6,
         `Trust` = Q26_7
         )

table4_data$`Savings Rate` <- factor(table4_data$`Savings Rate`, levels=importance_levels)
table4_data$`Term Length` <- factor(table4_data$`Term Length`, levels=importance_levels)
table4_data$`Cancellation Fee` <- factor(table4_data$`Cancellation Fee`, levels=importance_levels)
table4_data$`No On-Bill Credit` <- factor(table4_data$`No On-Bill Credit`, levels=importance_levels)
table4_data$`On-Bill Credit` <- factor(table4_data$`On-Bill Credit`, levels=importance_levels)
table4_data$`Contract Complexity` <- factor(table4_data$`Contract Complexity`, levels=importance_levels)
table4_data$`Trust` <- factor(table4_data$`Trust`, levels=importance_levels)

  


# summarize the data with our package
table4 <- tbl_summary(
  table4_data,
 # by=y_signup,
  missing='no',
  ) %>% # test for a difference between groups
  modify_header(label = "**Table 4: Developer and Financier Priorities: Factors to Fill out CS Projects Quickly**") %>% # update the column header
  bold_labels()

table4
```





<style>
#### Savings Rate
{
   display: none;
 }
</style>




```{r message=FALSE, warning=FALSE, include=FALSE}


sr_data <- dev_sum %>%
  mutate(
    sr = case_when(
      savings_rate=="0-5% savings per month" | savings_rate=="6-10% savings per month"  ~ 1,
      savings_rate=="11-15% savings per month" ~ 2,
      savings_rate=="16-20% savings per month" ~ 3,
      savings_rate=="21-50% savings per month" ~ 4,
      TRUE ~ 0
    )
  ) %>%
  mutate(new_sr_differ = case_when(
    savings_rate_differ=="Yes" ~ 1,
    savings_rate_differ=="No" ~ 0,
  )) %>%
  mutate(sr_one = case_when(
    sr == 1 ~ 1, 
    TRUE ~ 0
  ),
  sr_two = case_when(
    sr == 2 ~ 1, 
    TRUE ~ 0
  ),
  sr_three = case_when(
    sr == 3 ~ 1, 
    TRUE ~ 0
  ),
  sr_four = case_when(
    sr == 4 ~ 1, 
    TRUE ~ 0
  ))

sr_data$sr <- factor(sr_data$sr)

mylogit <- glm(new_sr_differ ~ sr, data = sr_data, family = "binomial")
summary(mylogit)




```






```{r message=FALSE, warning=FALSE, include=FALSE}
library(scales)

temp_data <- dev_sum %>%
  group_by(savings_rate) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=savings_rate, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("")+ ggtitle("Average Savings Rate for Community Solar")

ggplotly(p, tooltip="text")


## save out 

p <- ggplot(data=temp_data, aes(x=savings_rate, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("")+ ggtitle("Average Savings Rate for Community Solar") +
    geom_text(aes(label=total), position=position_dodge(width=0.9), vjust=-0.25)

p
```

34.4% of respondents marked savings rate from 0-10%; 33% recorded 11-15%, and 32.5% answered 16-50%. Hence, nearly two-thirds of respondents recorded over 10% for savings rate for community solar. 



```{r message=FALSE, warning=FALSE, include=FALSE}

temp_data <- dev_sum %>%
  group_by(savings_rate_differ) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=savings_rate_differ, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("") + ggtitle("Does Savings Rate Differ for LMI Customers")

ggplotly(p, tooltip="text")


```



```{r message=FALSE, warning=FALSE, include=FALSE}

temp_data <- dev_sum %>%
  filter(!is.na(savings_rate_lmi_differ)) %>%
  group_by(savings_rate_lmi_differ) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=savings_rate_lmi_differ, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("") + ggtitle("If Yes, how do savings rate differ for LMI Customers compared to market rates?")

ggplotly(p, tooltip="text")



```


<style>
#### Term Length
{
   display: none;
 }
</style>




```{r message=FALSE, warning=FALSE, include=FALSE}




temp_data <- dev_sum %>%
  group_by(term_length) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=term_length, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("")+ ggtitle("Average Term Length for Community Solar")

ggplotly(p, tooltip="text")




```


```{r message=FALSE, warning=FALSE, include=FALSE}


temp_data <- dev_sum %>%
  filter(!is.na(term_length_differ)) %>%
  group_by(term_length_differ) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=term_length_differ, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("") + ggtitle("Does Savings Rate Differ for LMI Customers")

ggplotly(p, tooltip="text")


```



```{r message=FALSE, warning=FALSE, include=FALSE}
temp_data <- dev_sum %>%
  filter(!is.na(term_length_lmi_differ)) %>%
  group_by(term_length_lmi_differ) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=term_length_lmi_differ, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("") + ggtitle("If Yes, how do term rates differ for LMI Customers compared to market rates?")

ggplotly(p, tooltip="text")


```





<style>
#### Cancellation Fee
{
   display: none;
 }
</style>





```{r message=FALSE, warning=FALSE, include=FALSE}


temp_data <- dev_sum %>%
  filter(!is.na(cancel_fee)) %>%
  group_by(cancel_fee) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=cancel_fee, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("")+ ggtitle("Average cancellation fee for Community Solar")

ggplotly(p, tooltip="text")



```





```{r message=FALSE, warning=FALSE, include=FALSE}

temp_data <- dev_sum %>%
  filter(!is.na(cancel_fee_differ)) %>%
  group_by(cancel_fee_differ) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=cancel_fee_differ, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("") + ggtitle("Does cancellation fee Differ for LMI Customers")

ggplotly(p, tooltip="text")



```



```{r message=FALSE, warning=FALSE, include=FALSE}
temp_data <- dev_sum %>%
  filter(!is.na(cancel_fee_lmi_differ)) %>%
  group_by(cancel_fee_lmi_differ) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=cancel_fee_lmi_differ, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("") + ggtitle("If Yes, how do cancellation fees differ for LMI customers compared to market rates?")

ggplotly(p, tooltip="text")



```


<style>
## Pie Charts
{
   display: none;
 }
</style>

<style>
### Factors: Ability to make CS accessibility to LMI {.tabset}
{
   display: none;
 }
</style>




```{r message=FALSE, warning=FALSE, include=FALSE}

importance_levels <- c("Not at all important", "Slightly important", "Moderately important", "Very important", "Extremely important")

temp_data <- devd %>%
  st_drop_geometry() %>%
  mutate(
    Q21_1 = factor(Q21_1, levels=importance_levels),
    Q21_2 = factor(Q21_2, levels=importance_levels),
    Q21_3 = factor(Q21_3, levels=importance_levels),
    Q21_4 = factor(Q21_4, levels=importance_levels),
    Q21_5 = factor(Q21_5, levels=importance_levels),
    Q21_6 = factor(Q21_6, levels=importance_levels),
    Q21_7 = factor(Q21_7, levels=importance_levels),
    Q21_8 = factor(Q21_8, levels=importance_levels)
  ) 

temp_data_1 <- temp_data %>%
  group_by(Q21_1) %>%
  filter(Q21_1 != "") %>%
  summarise(Q21_1=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance, Q21_1) 


temp_data_2 <- temp_data %>%
  group_by(Q21_2) %>%
  filter(Q21_2 != "") %>%
  summarise(Q21_2=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q21_2) 

temp_data_3 <- temp_data %>%
  group_by(Q21_3) %>%
  filter(Q21_3 != "") %>%
  summarise(Q21_3=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q21_3) 

temp_data_4 <- temp_data %>%
  group_by(Q21_4) %>%
  filter(Q21_4 != "") %>%
  summarise(Q21_4=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q21_4) 

temp_data_5 <- temp_data %>%
  group_by(Q21_5) %>%
  filter(Q21_5 != "") %>%
  summarise(Q21_5=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q21_5) 

temp_data_6 <- temp_data %>%
  group_by(Q21_6) %>%
  filter(Q21_6 != "") %>%
  summarise(Q21_6=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q21_6) 



final_data <- cbind(temp_data_1, temp_data_2,temp_data_3,temp_data_4,temp_data_5,temp_data_6)


final_data$order <- c(1,2,3,4,5)


```






#### CAC

```{r message=FALSE, warning=FALSE, include=FALSE}

#Q21_1

fig <- plot_ly(temp_data_1, labels = ~Importance, values = ~Q21_1, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'High customer acquisition costs',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


#### Churn
```{r message=FALSE, warning=FALSE, include=FALSE}
#Q21_2

fig <- plot_ly(temp_data_2, labels = ~Importance, values = ~Q21_2, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Risk of subscriber churn',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```

#### Default
```{r message=FALSE, warning=FALSE, include=FALSE}


#Q21_3

fig <- plot_ly(temp_data_3, labels = ~Importance, values = ~Q21_3, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Risk of subscriber default',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


#### Communication
```{r message=FALSE, warning=FALSE, include=FALSE}

#Q21_4

fig <- plot_ly(temp_data_4, labels = ~Importance, values = ~Q21_4, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Difficult to communicate community solar product',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


#### LMI ID
```{r message=FALSE, warning=FALSE, include=FALSE}

#Q21_5

fig <- plot_ly(temp_data_5, labels = ~Importance, values = ~Q21_5, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Difficulty qualifying households as LMI',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


#### Financing
```{r message=FALSE, warning=FALSE, include=FALSE}

#Q21_6

fig <- plot_ly(temp_data_6, labels = ~Importance, values = ~Q21_6, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Lack of available project financing',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

```

















### {-}


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
agg_data <- final_data[,c(1,2,4,6,8,10,12)] %>%
  mutate(new_cat = case_when(
    Importance == "Not at all important" | Importance == "Slightly important" ~ "No",
    Importance =="Moderately important" ~ "Maybe", 
    TRUE ~ "Yes"
  )) 


agg <- melt(agg_data, id="new_cat") %>%
  filter(variable!="Importance") %>%
  mutate(value = as.integer(value)) %>%
  group_by(variable) %>%
  summarise(
    No = sum(value[new_cat=="No"]),
    Maybe = sum(value[new_cat=="Maybe"]),
    Yes = sum(value[new_cat=="Yes"]),

    total=sum(value)

  )

agg
```

#### Takeaways

1. Customer aqcuisition costs (CAC) was the strongest factor, with 55.5% responding as either very or extremely important. 

2. Defaults were relatively less important, nearly a quarter (23.6%) responding that it was either not at all or slightly important. When compared to threat of churn, respondents shifted from slightly to moderately important, implying that churn is more of a concern compared to default. 



#### Bar Charts





```{r message=FALSE, warning=FALSE, include=FALSE}
library(reshape)

stacked_data <- melt(final_data, id='Importance') %>%
  filter(variable!="order") %>%
  mutate(order = case_when(
    Importance=="Not at all important" ~ 1,
    Importance=="Slightly important" ~ 2, 
    Importance=="Moderately important" ~ 3, 
    Importance=="Very important" ~ 4, 
    Importance=="Extremely important" ~ 5
  )) %>%
  mutate( Factors = case_when(
    variable=="Q21_1" ~ "High customer acquisition costs",
    variable=="Q21_2" ~ "Risk of subscriber churn",
    variable=="Q21_3" ~ "Risk of subscriber default",
    variable=="Q21_4" ~ "Difficulty communicating CS",
    variable=="Q21_5" ~ "Difficulty qualifying LMI HHs",
    variable=="Q21_6" ~ "Lack of project financing",
    
  )
    
  )



b <- ggplot(data = stacked_data, aes(x = reorder(Importance, -order), y = value, fill = Factors,
                                     text=paste("Factor", Factors, "\nValue:", value))) + 
       geom_bar(stat = 'identity', position = 'dodge') + coord_flip() + xlab("") + ylab("")+ theme_minimal()

ggplotly(b, tooltip="text")

```




```{r echo=FALSE, message=FALSE, warning=FALSE}
long_data <- stacked_data %>%
  mutate(
    pct_long = (value/218)
  )

long_data$Importance <- factor(long_data$Importance, levels = c("Extremely important", "Very important", "Moderately important",
                                                                "Slightly important", "Not at all important"))


long_data <- long_data %>%
  mutate(Importances = case_when(
    Importance == "Extremely important" | Importance == "Very important" ~ "Very/Extremely Important",
    Importance == "Moderately important" | Importance == "Slightly important" ~ "Slightly/Moderately Important",
    Importance == "Not at all important" ~ "Not at all important"
  ))


long_data$Importances <- factor(long_data$Importances, levels = c("Very/Extremely Important", "Slightly/Moderately Important", "Not at all important"))

ggplot(data = long_data, aes(x = Factors , y =pct_long , fill=Importance,
                                     text=paste("Factor", Factors, "\nValue:", pct_long))) + 
  geom_bar(stat = 'identity') + 
  #scale_colour_discrete("Importance")+
  coord_flip() + 
  xlab("") + 
  ylab("")+ 
  theme_minimal() +
  ggtitle("Factors to make Community Solar Accessible to LMI Customers")


ggplot(data = long_data, aes(x = Factors , y =pct_long , fill=Importances,
                                     text=paste("Factor", Factors, "\nValue:", pct_long))) + 
  geom_bar(stat = 'identity') + 
  #scale_colour_discrete("Importance")+
  coord_flip() + 
  xlab("") + 
  ylab("")+ 
  theme_minimal() +
  ggtitle("Factors to make Community Solar Accessible to LMI Customers")
      

```




### Factors: Influence decision to include LMI in projects {.tabset}

```{r message=FALSE, warning=FALSE, include=FALSE}


temp_data <- devd %>%
  st_drop_geometry() %>%
  mutate(
    Q24_1 = factor(Q24_1, levels=importance_levels),
    Q24_2 = factor(Q24_2, levels=importance_levels),
    Q24_3 = factor(Q24_3, levels=importance_levels),
    Q24_4 = factor(Q24_4, levels=importance_levels),
    Q24_5 = factor(Q24_5, levels=importance_levels)
  ) 

temp_data_1 <- temp_data %>%
  group_by(Q24_1) %>%
  filter(Q24_1 != "") %>%
  summarise(Q24_1=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance, Q24_1) 


temp_data_2 <- temp_data %>%
  group_by(Q24_2) %>%
  filter(Q24_2 != "") %>%
  summarise(Q24_2=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q24_2) 

temp_data_3 <- temp_data %>%
  group_by(Q24_3) %>%
  filter(Q24_3 != "") %>%
  summarise(Q24_3=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q24_3) 

temp_data_4 <- temp_data %>%
  group_by(Q24_4) %>%
  filter(Q24_4 != "") %>%
  summarise(Q24_4=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q24_4) 

temp_data_5 <- temp_data %>%
  group_by(Q24_5) %>%
  filter(Q24_5 != "") %>%
  summarise(Q24_5=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q24_5) 





final_data <- cbind(temp_data_1, temp_data_2,temp_data_3,temp_data_4,temp_data_5)


final_data$order <- c(1,2,3,4,5)



```





#### Policy

```{r echo=FALSE, message=FALSE, warning=FALSE}

temp_data_1$Importance = factor(temp_data_1$Importance, levels=importance_levels)

#Q24_1

fig <- plot_ly(temp_data_1, labels = ~Importance, values = ~Q24_1, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Policy/Program Requirements',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig




```


#### Community Interest
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Q24_2

fig <- plot_ly(temp_data_2, labels = ~Importance, values = ~Q24_2, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Community Interest',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig



```

#### Financier Interest
```{r echo=FALSE, message=FALSE, warning=FALSE}


#Q24_3

fig <- plot_ly(temp_data_3, labels = ~Importance, values = ~Q24_3, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Financier/Investor Interest',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig




```


#### Company Interest
```{r echo=FALSE, message=FALSE, warning=FALSE}

#Q24_4

fig <- plot_ly(temp_data_4, labels = ~Importance, values = ~Q24_4, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Company Interest',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig



```


#### Equity
```{r echo=FALSE, message=FALSE, warning=FALSE}

#Q24_5

fig <- plot_ly(temp_data_5, labels = ~Importance, values = ~Q24_5, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Equity and Inclusion',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```




### {-}

```{r message=FALSE, warning=FALSE, include=FALSE}
agg_data <- final_data[,c(1,2,4,6,8,10)] %>%
  mutate(new_cat = case_when(
    Importance == "Not at all important" | Importance == "Slightly important" ~ "No",
    Importance =="Moderately important" ~ "Maybe", 
    TRUE ~ "Yes"
  )) 


agg <- melt(agg_data, id="new_cat") %>%
  filter(variable!="Importance") %>%
  mutate(value = as.integer(value)) %>%
  group_by(variable) %>%
  summarise(
    No = sum(value[new_cat=="No"]),
    Maybe = sum(value[new_cat=="Maybe"]),
    Yes = sum(value[new_cat=="Yes"]),

    total=sum(value)

  )

agg
```

#### Takeaways

1. For factors influencing the decision to include LMI households in CS projects, the most common answer was policy requirements and equity/inclusion efforts, with 63% and 58% or respondents marking these as very or extremely important, respectively. 

2. Community interest exhibited a large degree of moderate importance, with 44.7% of respondents, whereas only 43% respondents marked it as either very or extremely important, the smallest proportion exhibited in each of the five questions. 

#### Bar Charts



```{r message=FALSE, warning=FALSE, include=FALSE}
stacked_data <- melt(final_data, id='Importance') %>%
  filter(variable!="order") %>%
  mutate(order = case_when(
    Importance=="Not at all important" ~ 1,
    Importance=="Slightly important" ~ 2, 
    Importance=="Moderately important" ~ 3, 
    Importance=="Very important" ~ 4, 
    Importance=="Extremely important" ~ 5
  )) %>%
  mutate( Factors = case_when(
    variable=="Q24_1" ~ "Policy/program requirements",
    variable=="Q24_2" ~ "Community interest",
    variable=="Q24_3" ~ "Financier/investor interest",
    variable=="Q24_4" ~ "My company's interest",
    variable=="Q24_5" ~ "Equity and inclusion"
    
  )
    
  ) %>%
  filter(!is.na(Factors))



b <- ggplot(data = stacked_data, aes(x = reorder(Importance, -order), y = value, fill = Factors,
                                     text=paste("Factor", Factors, "\nValue:", value))) + 
       geom_bar(stat = 'identity', position = 'dodge') + coord_flip() + xlab("") + ylab("")+ theme_minimal()

ggplotly(b, tooltip="text")

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
long_data <- stacked_data %>%
  mutate(
    pct_long = (value/218)
  )

long_data$Importance <- factor(long_data$Importance, levels = c("Extremely important", "Very important", "Moderately important",
                                                                "Slightly important", "Not at all important"))


long_data <- long_data %>%
  mutate(Importances = case_when(
    Importance == "Extremely important" | Importance == "Very important" ~ "Very/Extremely Important",
    Importance == "Moderately important" | Importance == "Slightly important" ~ "Slightly/Moderately Important",
    Importance == "Not at all important" ~ "Not at all important"
  ))


long_data$Importances <- factor(long_data$Importances, levels = c("Very/Extremely Important", "Slightly/Moderately Important", "Not at all important"))


ggplot(data = long_data, aes(x = Factors , y =pct_long , fill=Importance,
                                     text=paste("Factor", Factors, "\nValue:", pct_long))) + 
  geom_bar(stat = 'identity') + 
  #scale_colour_discrete("Importance")+
  coord_flip() + 
  xlab("") + 
  ylab("")+ 
  theme_minimal() +
  ggtitle("Factors to make Community Solar Accessible to LMI Customers")


ggplot(data = long_data, aes(x = Factors , y =pct_long , fill=Importances,
                                     text=paste("Factor", Factors, "\nValue:", pct_long))) + 
  geom_bar(stat = 'identity') + 
  #scale_colour_discrete("Importance")+
  coord_flip() + 
  xlab("") + 
  ylab("")+ 
  theme_minimal() +
  ggtitle("Factors to make Community Solar Accessible to LMI Customers")
      

```


### Factors: Fill out CS Projects Quickly {.tabset}

```{r message=FALSE, warning=FALSE, include=FALSE}

importance_levels <- c("Definitely not", "Probably not", "Might or might not", "Probably yes", "Definitely yes")

temp_data <- devd %>%
  st_drop_geometry() %>%
  mutate(
    Q26_1 = factor(Q26_1, levels=importance_levels),
    Q26_2 = factor(Q26_2, levels=importance_levels),
    Q26_3 = factor(Q26_3, levels=importance_levels),
    Q26_4 = factor(Q26_4, levels=importance_levels),
    Q26_5 = factor(Q26_5, levels=importance_levels),
    Q26_6 = factor(Q26_6, levels=importance_levels),
    Q26_7 = factor(Q26_7, levels=importance_levels)
  ) 

temp_data_1 <- temp_data %>%
  group_by(Q26_1) %>%
  filter(Q26_1 != "") %>%
  summarise(Q26_1=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance, Q26_1) 


temp_data_2 <- temp_data %>%
  filter(Q26_2 != "") %>%
  group_by(Q26_2, .drop=FALSE) %>%
  summarise(Q26_2=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q26_2) 

temp_data_3 <- temp_data %>%
  group_by(Q26_3) %>%
  filter(Q26_3 != "") %>%
  summarise(Q26_3=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q26_3) 

temp_data_4 <- temp_data %>%
  group_by(Q26_4) %>%
  filter(Q26_4 != "") %>%
  summarise(Q26_4=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q26_4) 

temp_data_5 <- temp_data %>%
  group_by(Q26_5) %>%
  filter(Q26_5 != "") %>%
  summarise(Q26_5=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q26_5) 

temp_data_6 <- temp_data %>%
  group_by(Q26_6) %>%
  filter(Q26_6 != "") %>%
  summarise(Q26_6=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q26_6) 


temp_data_7 <- temp_data %>%
  group_by(Q26_7) %>%
  filter(Q26_7 != "") %>%
  summarise(Q26_7=n()) %>%
  mutate(Importance = importance_levels) %>%
  select(Importance,Q26_7) 




final_data <- cbind(temp_data_1, temp_data_2,temp_data_3,temp_data_4,temp_data_5,temp_data_6,temp_data_7)


final_data$order <- c(1,2,3,4,5)


```


```{r message=FALSE, warning=FALSE, include=FALSE}
agg_data <- final_data[,c(1,2,4,6,8,10,12,14)] %>%
  mutate(new_cat = case_when(
    Importance == "Definitely not" | Importance == "Probably not" ~ "No",
    Importance =="Might or might not" ~ "Maybe", 
    TRUE ~ "Yes"
  )) 


agg <- melt(agg_data, id="new_cat") %>%
  filter(variable!="Importance") %>%
  mutate(value = as.integer(value)) %>%
  group_by(variable) %>%
  summarise(
    No = sum(value[new_cat=="No"]),
    Maybe = sum(value[new_cat=="Maybe"]),
    Yes = sum(value[new_cat=="Yes"]),

    total=sum(value)

  )

agg
```







#### Savings rate

```{r echo=FALSE, message=FALSE, warning=FALSE}

temp_data_1$Importance = factor(temp_data_1$Importance, levels=importance_levels)

#Q26_1

fig <- plot_ly(temp_data_1, labels = ~Importance, values = ~Q26_1, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Savings rate',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig



```


#### Term length
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Q26_2

fig <- plot_ly(temp_data_2, labels = ~Importance, values = ~Q26_2, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Contract term length',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

```

#### Cancel fee
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Q26_3

fig <- plot_ly(temp_data_3, labels = ~Importance, values = ~Q26_3, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Cancellation fees',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

```


#### No On-bill credit
```{r echo=FALSE, message=FALSE, warning=FALSE}

#Q26_4

fig <- plot_ly(temp_data_4, labels = ~Importance, values = ~Q26_4, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Lack of on-bill crediting',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

```


#### On-bill credit
```{r echo=FALSE, message=FALSE, warning=FALSE}

#Q26_5

fig <- plot_ly(temp_data_5, labels = ~Importance, values = ~Q26_5, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Presence of on-bill crediting',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

```

#### Contract complex
```{r echo=FALSE, message=FALSE, warning=FALSE}

#Q26_6

fig <- plot_ly(temp_data_6, labels = ~Importance, values = ~Q26_6, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Contract complexity/length',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig


```


#### Trust
```{r echo=FALSE, message=FALSE, warning=FALSE}


#Q26_7

fig <- plot_ly(temp_data_7, labels = ~Importance, values = ~Q26_7, type = 'pie', sort=F)
fig <- fig %>% layout(title = 'Trust of developers or project owners',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

```








### {-}


#### Takeaways

1. presence of on-bill credit for community solar projects exhibited the strongest positive response, with 58% of respondents recording it as probably or definitely impacted speed of CS projects being completed. 
2. Conversely, though marginally different, contract complexity and trust were the least powerful, with 17.6% and 19% of respondents, respectively, stating it either probably not or definitely did not have an effect on projects being quickly filled out.   


#### Bar Charts




```{r message=FALSE, warning=FALSE, include=FALSE}
stacked_data <- melt(final_data, id='Importance') %>%
  filter(variable!="order") %>%
  mutate(order = case_when(
    Importance=="Definitely not" ~ 1,
    Importance=="Probably not" ~ 2, 
    Importance=="Might or might not" ~ 3, 
    Importance=="Probably yes" ~ 4, 
    Importance=="Definitely yes" ~ 5
  )) %>%
  mutate( Factors = case_when(
    variable=="Q26_1" ~ "Savings rate",
    variable=="Q26_2" ~ "Contract term length",
    variable=="Q26_3" ~ "Termination fees",
    variable=="Q26_4" ~ "Lack of on-bill crediting",
    variable=="Q26_5" ~ "Presence of on-bill crediting",
    variable=="Q26_6" ~ "Contract complexity/length",
    variable=="Q26_7" ~ "Trust of developers or project owners"    
  )
    
  ) %>%
  filter(!is.na(Factors))



b <- ggplot(data = stacked_data, aes(x = reorder(Importance, -order), y = value, fill = Factors,
                                     text=paste("Factor", Factors, "\nValue:", value))) + 
       geom_bar(stat = 'identity', position = 'dodge') + coord_flip() + xlab("") + ylab("")+ theme_minimal()

ggplotly(b, tooltip="text")

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
long_data <- stacked_data %>%
  mutate(
    pct_long = (value/218)
  )

long_data$Importance <- factor(long_data$Importance, levels = c("Definitely yes", "Probably yes", "Might or might not",
                                                                "Probably not", "Definitely not"))


long_data <- long_data %>%
  mutate(Importances = case_when(
    Importance == "Definitely yes" | Importance == "Probably yes" ~ "Definite or Probable Yes",
    Importance == "Might or might not" ~ "Might or might not",
    Importance == "Probably not" | Importance == "Definitely not" ~ "Definite or Probable No"
  ))

long_data$Importances <- factor(long_data$Importances, levels = c("Definite or Probable Yes", "Might or might not",
                                                                "Definite or Probable No"))

ggplot(data = long_data, aes(x = Factors , y =pct_long , fill=Importance,
                                     text=paste("Factor", Factors, "\nValue:", pct_long))) + 
  geom_bar(stat = 'identity') + 
  #scale_colour_discrete("Importance")+
  coord_flip() + 
  xlab("") + 
  ylab("")+ 
  theme_minimal() +
  ggtitle("Factors to make Community Solar Accessible to LMI Customers")


ggplot(data = long_data, aes(x = Factors , y =pct_long , fill= Importances,
                                     text=paste("Factor", Factors, "\nValue:", pct_long))) + 
  geom_bar(stat = 'identity') + 
  #scale_colour_discrete("Importance")+
  coord_flip() + 
  xlab("") + 
  ylab("")+ 
  theme_minimal() +
  ggtitle("Factors to make Community Solar Accessible to LMI Customers")
      
      

```


<style>
### Savings Rate for Market and LMI
{
   display: none;
 }
</style>

```{r message=FALSE, warning=FALSE, include=FALSE}

default_levels <- c("0-2%", "3-5%", "6-8%", "9-11%")
churn_levels <-  c("0-4%", "5-10%", "11-15%", "16-20%")

temp_data <- dev_sum %>%
  mutate(
    default_market = factor(default_market, levels=default_levels),
    default_lmi = factor(default_lmi, levels=default_levels),
  ) 

temp_dev <- dev_sum %>%
  filter(default_market != "Unsure") %>%
  group_by(default_market) %>%
  summarise(default_market=n()) %>%
  mutate(Importance = default_levels,
         pct_market = default_market/sum(default_market)) %>%
  select(Importance, default_market) 


temp_lmi <- dev_sum %>%
  filter(default_lmi != "Unsure") %>%
  filter(default_lmi !="") %>%
  group_by(default_lmi) %>%
  summarise(default_lmi=n()) %>%
  mutate(Importance = default_levels,
         pct_lmi = default_lmi/sum(default_lmi)) %>%
  select(default_lmi) 





final_data <- cbind(temp_dev, temp_lmi)


final_data$order <- c(1,2,3,4)




```



```{r message=FALSE, warning=FALSE, include=FALSE}
stacked_data <- melt(final_data, id='Importance') %>%
  filter(variable!="order") %>%
  mutate(order = case_when(
    Importance=="0-2%" ~ 1,
    Importance=="3-5%" ~ 2, 
    Importance=="6-8%" ~ 3, 
    Importance=="9-11%" ~ 4
  )) %>%
  mutate( Factors =  variable) %>%
  filter(!is.na(Factors))


b <- ggplot(data = stacked_data, aes(x = reorder(Importance, -order), y = value, fill = Factors,
                                     text=paste("Factor", Factors, "\nValue:", value))) + 
       geom_bar(stat = 'identity', position = 'dodge') + coord_flip() + xlab("") + ylab("")+ theme_minimal() +
      ggtitle("Guess the default rate you experience for the two groups:")

ggplotly(b, tooltip="text")

```


<style>
### Churn Rate for Market and LMI
{
   display: none;
 }
</style>


```{r message=FALSE, warning=FALSE, include=FALSE}

default_levels <- c("0-2%", "3-5%", "6-8%", "9-11%")
churn_levels <-  c("0-4%", "5-10%", "11-15%", "16-20%")

temp_data <- dev_sum %>%
  mutate(
    churn_market = factor(churn_market, levels=churn_levels),
    churn_lmi = factor(churn_lmi, levels=churn_levels),
  ) 

temp_dev <- temp_data %>%
  filter(churn_market != "Unsure") %>%
  group_by(churn_market) %>%
  summarise(churn_market=n()) %>%
  mutate(Importance = churn_levels) %>%
  select(Importance, churn_market) 


temp_lmi <- temp_data %>%
  filter(churn_lmi != "Unsure") %>%
  group_by(churn_lmi) %>%
  summarise(churn_lmi=n()) %>%
  mutate(Importance = churn_levels) %>%
  select( churn_lmi) 



final_data <- cbind(temp_dev, temp_lmi)


final_data$order <- c(1,2,3,4)




```



```{r message=FALSE, warning=FALSE, include=FALSE}
stacked_data <- melt(final_data, id='Importance') %>%
  filter(variable!="order") %>%
  mutate(order = case_when(
    Importance=="0-4%" ~ 1,
    Importance=="5-10%" ~ 2, 
    Importance=="11-15%" ~ 3, 
    Importance=="16-20%" ~ 4
  )) %>%
  mutate( Factors =  variable) %>%
  filter(!is.na(Factors))


b <- ggplot(data = stacked_data, aes(x = reorder(Importance, -order), y = value, fill = Factors,
                                     text=paste("Factor", Factors, "\nValue:", value))) + 
       geom_bar(stat = 'identity', position = 'dodge') + coord_flip() + xlab("") + ylab("")+ theme_minimal() +
      ggtitle("Guess the churn rate you experience for the two groups:")

ggplotly(b, tooltip="text")

```

<style>
### Project stage by highest churn/default
{
   display: none;
 }
</style>


COD = commerical operational date (?)



```{r message=FALSE, warning=FALSE, include=FALSE}

time_levels <- c("Prior to COD", "Within first year of operation", "Within 1-3 years", "Within 3-5 years", "After 5 years")


temp_data <- dev_sum %>%
  mutate(
    churn_time = factor(Q30_1, levels=time_levels),
    default_time = factor(Q30_2, levels=time_levels),
  ) 

temp_churn <- temp_data %>%
  filter(churn_time !="") %>%
  group_by(churn_time) %>%
  summarise(churn_time=n()) %>%
  mutate(Importance = time_levels) %>%
  select(Importance, churn_time) 


temp_default <- temp_data %>%
  filter(default_time !="") %>%
  group_by(default_time) %>%
  summarise(default_time=n()) %>%
  mutate(Importance = time_levels) %>%
  select( default_time) 



final_data <- cbind(temp_churn, temp_default)


final_data$order <- c(1,2,3,4,5)




```



```{r message=FALSE, warning=FALSE, include=FALSE}
stacked_data <- melt(final_data, id='Importance') %>%
  filter(variable!="order") %>%
  mutate(order = case_when(
    Importance=="Prior to COD" ~ 1,
    Importance=="Within first year of operation" ~ 2, 
    Importance=="Within 1-3 years" ~ 3, 
    Importance=="Within 3-5 years" ~ 4,
    Importance=="After 5 years" ~ 5
  )) %>%
  mutate( Factors =  variable) %>%
  filter(!is.na(Factors))


b <- ggplot(data = stacked_data, aes(x = reorder(Importance, -order), y = value, fill = Factors,
                                     text=paste("Factor", Factors, "\nValue:", value))) + 
       geom_bar(stat = 'identity', position = 'dodge') + coord_flip() + xlab("") + ylab("")+ theme_minimal() +
      ggtitle("Project Phase where highest rates observed:")

ggplotly(b, tooltip="text")

```


<style>
## Loan Loss Reserve {
   display: none;
 }
</style>



<style>
### Alleviate Risk
{
   display: none;
 }
</style>

```{r message=FALSE, warning=FALSE, include=FALSE}

risk_levels <- c("Moderately unlikely","Slightly unlikely" , "Neither likely nor unlikely", "Moderately likely", "Slightly likely", "Extremely likely")



temp_data <- dev_sum %>%
  mutate(
    loan_loss_risk = factor(Q33_1, levels=risk_levels),
  ) %>%
  filter(!is.na(loan_loss_risk)) %>%
  group_by(loan_loss_risk) %>%
  summarise(total = n()) %>%
  mutate(percent_total = percent(total/sum(total)))

p<-ggplot(data=temp_data, aes(x=loan_loss_risk, y=total))+
  geom_bar(stat = 'identity', aes(text=paste0(
    "Total: ", total,
    "<br>",
    "Percent: ", percent_total
  ))) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("")+ ggtitle("Average cancellation fee for Community Solar")

ggplotly(p, tooltip="text")


```



<style>
### Ideal Loan Loss Reserve
{
   display: none;
 }
</style>




```{r message=FALSE, warning=FALSE, include=FALSE}



temp_data <- dev_sum %>%
  mutate(
    loan_loss_rev = as.integer(Q34_1),
  ) %>%
  filter(!is.na(loan_loss_rev)) 




p<-ggplot(data=temp_data, aes(x=loan_loss_rev)) +
  #geom_line(stat="count") + 
  geom_histogram(binwidth=10) +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("% Revenue Covered")+ ggtitle("percentage of total project revenue for ideal loan loss reserve (10% bin)")
ggplotly(p)



```




```{r message=FALSE, warning=FALSE, include=FALSE}


#Removed values of ideal loss reserve revenue protection of 2018 anad 50000

temp_data <- dev_sum %>%
  mutate(
    loan_loss_rev = as.integer(Q35_1),
  ) %>%
  filter(!is.na(loan_loss_rev)) %>%
  filter(loan_loss_rev < 2000)




p<-ggplot(data=temp_data, aes(x=loan_loss_rev)) +
  # geom_line(stat="count") +
  geom_histogram(binwidth=10) + 
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  xlab("Years")+ ggtitle("Ideal number of years loan loss reserve would cover (10 year bin)")
ggplotly(p)



```


-1




# Discussion



## Respondent Map

Coordinates have been obfuscated to protect location. 


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(leaflet)
library(tidycensus)
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
#  addTiles() %>%
  addCircleMarkers(data=devd,
             radius=8)
```