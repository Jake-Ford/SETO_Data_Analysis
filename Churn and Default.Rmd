---
title: "Churn and Default"
author: "Jacob Ford, Solstice Data Scientist"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    toc_depth: 5

knit: (function(inputFile, encoding) { 
        rmarkdown::render(inputFile, encoding = encoding, 
        output_file = file.path(dirname(inputFile), 'churn_and_default.html')) })
---






# Introduction

For this portion of the research, customers in existing solar farm projects are evaluated for their subscription and payment status. Participation in community solar farms is voluntary, hence customers may exit the program at any point, often subject to a cancellation fee set out in the contract. Additionally, customers sometimes fail to pay the monthly solar farm subscription fee. Churn refers to the act of a customer exiting the solar farm, whereas default refers to the customer failing to pay the monthly subscription fee. 

Given the incipient nature of community solar, this analysis provides an opportunity to quantify the likelihood of churn or default, along with determining any household or demographic attribute associated with statistically different rates of either churn or default. The goal of the analysis is to first describe the characteristics of the residents, the prevalence of default and/or churn rates, the prevalence of churn rates, and any statistically significant differences between groups in their default, late payments or churn rates.

## Literature Review

**to-do: to be added/folded into the Introduction to frame the macro-scope of this study**




# Methods


**note**

*Analysis is awaiting Experian appending.* 

## Data Collection


Customer data is collected from two solar farms, the [Frog Hollow Solar Farm](https://communitysolar.energysage.com/projects/frog-hollow-solar-farm) and [Howell Solar Farm](https://communitysolar.energysage.com/projects/howell-solar-farm). Monthly account level data was collected from January 2020 to April 2022. Account level information includes monthly payment performance, for which churn and default triggers may be captured. 

The data consists of 32,385 monthly observations over 813 homes, 812 accounts and 621 users. To avoid data quality issues and to analyze any potential churn and default trends, for Frog Hollow households the analysis will drop values in October 2021 until April 2022. This narrowed dataset is comprised of 31,704 observations; the homes, accounts and users did not change.  




```{r message=FALSE, warning=FALSE, include=FALSE}

#Load packages we'll need throughout the entire document

library(readxl)
library(sf)
library(dplyr)
library(janitor)
library(dplyr)
library(tidyverse)
library(nngeo)
library(plotly)
library(kableExtra)
library(haven)
library(rms)
library(rmdformats)
library(gtsummary)
library(ggplot2)
library(plotly)


options(scipen = 100)


```

```{r message=FALSE, warning=FALSE, include=FALSE}

## Change the below to match your local drive ##

input_folder <- '/Volumes/GoogleDrive/Shared drives/*Solstice | Low Income Inclusion/Projects/2019-2022 DOE SETO Contract Innovations/DOE SETO Project Implementation/Project Management/SETO Data Analysis/'


setwd(input_folder)


```



```{r message=FALSE, warning=FALSE, include=FALSE}

# 'raw' contains the monthly enrollment records for the sample solar farm - contains various account specific information

# There are three main ID variables to consider: user (user_id),  household (property_id) and utility account (utility_acct_number); we decided to group the analysis by accounts. The reason is simply that what we are measuring is rate of churn/default, and the account is the unit that performs these actions; not the user which may hold multiple accounts. Household ID and utility account are very similar, but for consistency, we hearafter focus on utlity account data



raw <- read_excel(paste(input_folder, "3. Churn and Default/Central Hudson Preliminary Analysis/Nautilus Raw Data.xlsx", sep=""), 
    sheet = "final data")


#  'leave_reason' - trigger that captures reason why an individual leaves a solar farm ; for non-churn/non-default records, it should be set to 0 (zero), not 'none' just for consitency


raw$leave_reason[raw$leave_reason=="none"] <- 0


raw <- raw %>%
  #filter particular case that was entered in error
  filter(user_id!=8377) %>%
  # make tag for frog hollow properties after 9/2021; assuming the entries for april 2022 are legit, this drops October 2021 values 
  mutate(FH_bill_issuetag = case_when(
         solar_farm_name=="Frog Hollow (CHGE)" & year == 2021 & month > 9 ~ 1,
         TRUE ~ 0),
         
         # Create dummy variable for default, the more extreme case of churn; every default is a churn, not ever churn is a default of course
         default_dummy = case_when(
           leave_reason =="Default Payment" ~ 1,
           TRUE ~ 0),
         
         churn_dummy = case_when(
           leave_reason !=0 ~ 1, 
           TRUE ~ 0
         )) %>%
  filter(FH_bill_issuetag !=1) %>%
  # create logarithmic transformation of kwh allocation for model later
  mutate(
    log_solar = case_when(
      kwh_allocated>0 ~ log(kwh_allocated),
      TRUE ~ 0
    )
  ) 
```




```{r message=FALSE, warning=FALSE, include=FALSE}

#group by the utility account number to get descriptive stats

flipped <- raw %>%
  group_by(utility_acct_number) %>%
  summarise(
            n= n(),
            tenure = length(unique(date_concat)),
            HH_Income = unique(`HH Income`),
            payment_method = unique(payment_type),
            # divide kwh_allocated by 1229 to get kWh per account level
            kwh_solar = mean(kwh_allocated/1229),
            Churn = max(churn_dummy),
            Default = max(default_dummy),
            solar_farm = unique(solar_farm_name)) %>%
            # Proj_Frog_Hollow_dummy = sum(solar_farm_name=="Frog Hollow (CHGE)"),
            # Proj_Howell_dummy = sum(solar_farm_name=="Howell (O&R)")) %>%
  mutate(
    count_user_id = n(),
    Income = case_when(
      HH_Income==">=$50,000" ~ "High",
      HH_Income=="$0-$49,999" ~ "Low"
  )) %>%
dplyr::select(-HH_Income)


## filter out the duplicates


dupes <- flipped %>%
  filter(count_user_id == 2) %>%
  # duplicates are removed by only chosing the ACH payment method, there were duplicate 'card' payment entries 
  filter(payment_method == "ach")

no_dupes <- flipped %>%
  filter(count_user_id==1) 

```





```{r echo=FALSE, message=FALSE, warning=FALSE}
## join back with the main data

joined <- rbind(no_dupes, dupes) %>%
  select(-n,-count_user_id)
  
```


The first ten rows of the data are presented, grouped by account number. Unique identifiers were replaced with sequential IDs. 

* Tenure: length in months each account was active 
* Payment_Method: either card or ACH/direct debit method
* kwh_solar: annual (right?) solar allocation in kWh 
* Churn: binary _var_iable capturing if an account left the solar farm
* defauted: binary variable capturing if account holder Default on payment
* Income: Low (<$50,000) or High (>$50,000)
* Solar_Farm: Either Howell or Frog Hollow


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

##remove account ID and replace with dummy sequence
joined$Account_ID <- seq(1,nrow(joined),1)

# drop account ID for privacy concerns 
temp <- joined[,-1]

temp <- temp %>%
  relocate(Account_ID)



head(temp, 10) %>%
  kbl(caption = "First 10 Rows",  digits=2) %>%
  kable_classic(full_width = T, html_font = "Cambria")
```

  




### Descriptive Statistics



Account level summary statistics by solar farm are provided in Table 1 below. 

(hold for experian data to add more descriptives)

The number of Churn and Default events are captured in Table 1. Note, the relative rare occurence of defaulting likely removes the possiblity of determining any statistically significant difference between customer attributes. However, of the 812 accounts, 118 or just over 14.5% of accounts, experienced churn. 


```{r echo=FALSE, message=FALSE, warning=FALSE}
tbl_one <-
  joined %>%
  ungroup() %>%
 # filter(solar_farm == "Howell (O&R)") %>%
  select(`Average Tenure` = tenure,  solar_farm, `Average kWh` = kwh_solar, Income, `Payment Method`=payment_method,Churn, Default) %>%
  tbl_summary(by = solar_farm) %>%
  modify_header(label = "**Table 1: Summary Statistics by Solar Farm**") %>% 
  bold_labels() %>%
  add_overall()

tbl_one
```


Average tenure for the entire dataset is just under two years (22 months). Table 2 provides descriptive statistics grouped by tenure length. Longer tenured households had larger solar allocations compared to lower tenured households, 7.3 kWH for 2+ year customers compared to 3.7 for < 6 months. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
#joined$tenure_length <- factor(joined$tenure_length, levels=c("Less than 6", "6-12", "12-24", "Over 24"))


#levels(joined$tenure_length) <- c("Less than 6", "6-12", "12-24", "Over 24")

tbl_two <-
  joined %>%
    mutate( tenure_length = case_when(
    tenure < 6 ~ 0,
    tenure > 6 & tenure < 12 ~ 1,
    tenure > 12 & tenure < 24 ~ 2,
    tenure >= 24~ 3
  )) %>% 
  
  mutate(tenure_length = recode(tenure_length,
         '0' = "< 6 Months",
         '1' = "6-12 Months",
         '2' = "12-24 Months",
         '3' = "Over 24 Months")) %>%
  
  arrange(desc(tenure_length)) %>%
  
  ungroup() %>%
 # filter(solar_farm == "Howell (O&R)") %>%
  select(`Average Tenure` = tenure, tenure_length, `Average kWh` = kwh_solar, Income, `Payment Method`=payment_method,Churn, Default) %>%
  tbl_summary(by = tenure_length) %>%
  modify_header(label = "**Table 2: Summary Statistics by Tenure Length**") %>% 
  bold_labels() %>%
  add_overall()

tbl_two
```











## Model 

To determine the probability an account will experience either churn or default, a logistic regression is used to construct a model. The model in brief is described below.

In the limited data available, statistically significant effects were measured for probability of churn for both tenure (Months) and days late. Due to relatively small number of observations of late payments, no statistically significant results were measured in probability of late or default payments. 


\begin{equation}

P_{d} = \beta_{0} + \beta_{1}*Months +\beta_{2}*(Payment Method = Card) +\beta_{3}*Income=Low \\ +\beta_{4}*Solar kwH + \beta{5}*(Solar Farm=Howell)

\end{equation}





# Results


* note on 9-9-:

need to include logistic models, not these stupid ggplots - think of ways to visualize these later, probably same methods that'll be used in community priorities 
- OR tables, etc. 


## Churn Figures 

### Solar

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(plotly)

myColors <- c("green", "red")

# p <- ggplot(data=group_by_home, aes(x=Income, y = Avg_DaysLate, color=factor(Default_Tag))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +
#   labs(colour="Default") + theme_classic()
# 
# ggplotly(p)


p <- ggplot(data=joined, aes(x=Income, y = kwh_solar, color=factor(Churn))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Solar kWh") +theme_classic() 

ggplotly(p)


p <- ggplot(data=joined, aes(x=payment_method, y = kwh_solar, color=factor(Churn))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Solar kWh") +theme_classic() 

ggplotly(p)

p <- ggplot(data=joined, aes(x=tenure, y = kwh_solar, color=factor(Churn))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Solar kWh") +theme_classic() + geom_smooth(data=subset(joined,Churn==1 | Churn==0),
               aes(tenure,kwh_solar,color=factor(Churn)),method=lm,se=FALSE)

ggplotly(p)

```




### Tenure & Churn by Payment Method 

```{r echo=FALSE, message=FALSE, warning=FALSE}



p <- ggplot(data=joined, aes(x=Income, y = tenure, color=factor(Churn))) + geom_point(stat="identity") +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)

p <- ggplot(data=joined, aes(x=Income, y = tenure, color=factor(Churn))) + geom_bar(stat="identity") +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)


p <- ggplot(data=joined, aes(x=payment_method, y = tenure, color=factor(Churn))) + geom_point(stat="identity") +  scale_color_manual(values=myColors) +  labs(colour="Churn Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)


p <- ggplot(data=joined, aes(x=payment_method, y = tenure, color=factor(Churn))) + geom_bar(stat="identity") +  scale_color_manual(values=myColors) +  labs(colour="Churn Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)
```







## Default Figures 

### Solar

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(plotly)

myColors <- c("green", "red")

# p <- ggplot(data=group_by_home, aes(x=Income, y = Avg_DaysLate, color=factor(Default_Tag))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +
#   labs(colour="Default") + theme_classic()
# 
# ggplotly(p)


p <- ggplot(data=joined, aes(x=Income, y = kwh_solar, color=factor(Default))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Solar kWh") +theme_classic() 

ggplotly(p)


p <- ggplot(data=joined, aes(x=payment_method, y = kwh_solar, color=factor(Default))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Solar kWh") +theme_classic() 

ggplotly(p)

p <- ggplot(data=joined, aes(x=tenure, y = kwh_solar, color=factor(Default))) + geom_point() +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Churn Status") + ylab("Solar kWh") +theme_classic() + geom_smooth(data=subset(joined,Default==1 | Default==0),
               aes(tenure,kwh_solar,color=factor(Default)),method=lm,se=FALSE)

ggplotly(p)

```




### Tenure & Default by Payment Method 

```{r echo=FALSE, message=FALSE, warning=FALSE}



p <- ggplot(data=joined, aes(x=Income, y = tenure, color=factor(Default))) + geom_point(stat="identity") +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Default Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)

p <- ggplot(data=joined, aes(x=Income, y = tenure, color=factor(Default))) + geom_bar(stat="identity") +  scale_color_manual(values=myColors, labels=c('No', 'Yes')) +  labs(colour="Default Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)


p <- ggplot(data=joined, aes(x=payment_method, y = tenure, color=factor(Default))) + geom_point(stat="identity") +  scale_color_manual(values=myColors) +  labs(colour="Default Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)


p <- ggplot(data=joined, aes(x=payment_method, y = tenure, color=factor(Default))) + geom_bar(stat="identity") +  scale_color_manual(values=myColors) +  labs(colour="Default Status") + ylab("Tenure") +theme_classic() 

ggplotly(p)
```

















```{r echo=FALSE, message=FALSE, warning=FALSE}

# Logit Models

joined$Income <- as.factor(joined$Income)


#model_default <- glm(Default_Tag ~ Months +  Avg_DaysLate + Avg_Solar + Income + DPD_30_Tag + DPD_60_Tag + DPD_90_Tag, family=binomial(link='logit'), data=group_by_home)


model_churn <- glm(Churn ~ tenure  + payment_method + Income + kwh_solar + solar_farm, family=binomial(link='logit'), data=joined)
summary(model_churn)



```





The logit curves below show the relationship between the distribution of both tenure and days late with the probability of churning. The first graph shows that the longer the tenure, the lower the likelihood. The second graph shows that the days of late payments are generally not associated with likelihood of churn. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Logit Curves - none significant except churn


ggplot(joined, aes(x=tenure, y = Churn))+ geom_point(fill='red') + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Months") +
  scale_y_continuous(name="Likelihood of Churn")




ggplot(joined, aes(x=kwh_solar, y = Churn))+ geom_point(fill='red') + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Solar kWh") +
  scale_y_continuous(name="Likelihood of Churn")

```





# Discussion

